<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>sheyd</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />

  <style>
    /* ========== Base ========== */
    :root {
      --bg-color: #121212;
      --text-color: #e0e0e0;
      --header-text: #bb86fc;
      --nav-link-color: #bbb;
      --nav-link-hover: #bb86fc;
      --btn-bg: #bb86fc;
      --btn-color: #121212;
      --btn-hover-bg: #9a67ea;
      --particle-color: rgba(187, 134, 252, 0.3);

      --header-height: 76px;
      --container-width: 900px;
    }

    *{box-sizing:border-box; margin:0; padding:0;}
    html,body{height:100%}
    body{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      background:var(--bg-color);
      color:var(--text-color);
      font-family:'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      transition:background-color .6s, color .6s;
      scroll-behavior:smooth;
    }
    body.light{
      --bg-color:#e6f0ff;
      --text-color:#222;
      --header-text:#4b32a8;
      --btn-bg:#4b32a8;
      --btn-color:#fff;
      --btn-hover-bg:#6a4bca;
      --particle-color:rgba(75,50,168,0.25);
    }

    a{color:inherit;text-decoration:none}

    /* ========== Header: fixed and perfectly centered block ========== */
    header{
      position:sticky;
      top:0;
      left:0;
      right:0;
      height:var(--header-height);
      display:grid;
      grid-template-columns: 1fr auto 1fr; /* left gap / center / right controls */
      align-items:center;
      z-index:20;
      background:transparent;
      backdrop-filter: blur(6px);
      padding: 0 20px;
      border-bottom:1px solid rgba(255,255,255,0.02);
    }

    /* center column - logo + nav grouped and centered */
    .center-wrap{
      grid-column:2;
      justify-self:center;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      pointer-events:auto;
    }

    .top-row{
      display:flex;
      align-items:center;
      gap:18px;
      justify-content:center;
      flex-wrap:wrap;
    }

    header h1{
      font-size:20px;
      font-weight:700;
      color:var(--header-text);
      letter-spacing:1.5px;
      cursor:pointer;
      user-select:none;
      margin:0;
    }

    nav{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:center;
      flex-wrap:wrap;
    }
    nav a{
      color:var(--nav-link-color);
      font-weight:500;
      padding:6px 8px;
      border-radius:6px;
      transition:color .2s, background .15s;
      font-size:14px;
    }
    nav a:hover, nav a.active{
      color:var(--nav-link-hover);
      background:rgba(255,255,255,0.02);
      border-bottom:2px solid var(--nav-link-hover);
      padding-bottom:4px;
    }

    /* right controls column */
    .header-right{
      grid-column:3;
      justify-self:end;
      display:flex;
      align-items:center;
      gap:8px;
      pointer-events:auto;
    }

    .chip{
      cursor:pointer;
      background:rgba(0,0,0,0.12);
      border:1px solid rgba(187,134,252,0.35);
      color:var(--header-text);
      font-weight:600;
      padding:6px 12px;
      border-radius:18px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      min-width:44px;
      height:36px;
      transition:background .15s,color .15s;
    }
    .chip:hover{ background:rgba(187,134,252,0.08); color:var(--btn-color) }

    /* ========== Main & container (content centered) ========== */
    main{
      margin-top: calc(var(--header-height) + 20px);
      display:flex;
      justify-content:center;
      width:100%;
      padding: 0 16px 60px;
      flex:1;
    }

    .container{
      width:100%;
      max-width:var(--container-width);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:36px;
    }

    section{
      width:100%;
      padding:48px 36px;
      border-radius:12px;
      background:transparent;
      display:flex;
      flex-direction:column;
      align-items:center;
      text-align:center;
      box-shadow:0 8px 30px rgba(0,0,0,0.35);
    }

    #main-scene h2{ font-size:28px; color:var(--header-text); margin-bottom:12px }
    #main-scene p{ font-size:16px; max-width:760px; color:var(--text-color) }

    .btn{
      margin-top:18px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:12px 26px;
      border-radius:22px;
      background:var(--btn-bg);
      color:var(--btn-color);
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:1.6px;
      cursor:pointer;
      box-shadow:0 10px 30px rgba(154,103,234,0.12);
    }
    .btn:hover{ background:var(--btn-hover-bg) }

    footer{
      width:100%;
      max-width:var(--container-width);
      margin:28px auto 36px;
      text-align:center;
      color:rgba(255,255,255,0.7);
      font-size:13px;
      padding:8px;
      border-top:1px solid rgba(255,255,255,0.03);
      border-radius:8px;
    }

    /* modal and toast */
    .secret-modal{
      position:fixed;
      left:50%;
      top:50%;
      transform:translate(-50%,-50%) scale(.96);
      min-width:300px;
      background:linear-gradient(135deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      border:1px solid rgba(255,255,255,0.06);
      padding:20px;
      border-radius:12px;
      box-shadow:0 10px 40px rgba(0,0,0,0.6);
      display:none;
      z-index:1200;
    }
    .secret-modal.show{ display:block; transform:translate(-50%,-50%) scale(1) }

    #toast{
      position:fixed;
      right:18px;
      bottom:18px;
      background:rgba(0,0,0,0.78);
      color:#fff;
      padding:10px 14px;
      border-radius:10px;
      opacity:0;
      transform:translateY(8px);
      transition:opacity .18s, transform .18s;
      z-index:2000;
      pointer-events:none;
    }
    #toast.show{ opacity:1; transform:translateY(0); pointer-events:auto }

    /* Achievements list styling (kept) */
    .ach-list{ width:100%; max-width:700px; background:rgba(255,255,255,0.02); padding:18px; border-radius:12px; border:1px solid rgba(255,255,255,0.03) }

    /* ========== Info section layout: left info + right suggestions ========== */
    #info .info-grid{
      width:100%;
      display:grid;
      grid-template-columns: 1fr 380px;
      gap:20px;
      align-items:start;
    }

    #info .info-left{
      text-align:left;
      padding:8px 12px;
    }
    #info .info-left h3{ margin-top:0; color:var(--header-text) }
    #info .info-right{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      padding:12px;
      border-radius:10px;
      text-align:left;
    }

    .suggestion-form textarea{
      width:100%;
      min-height:96px;
      padding:10px;
      resize:vertical;
      border-radius:8px;
      background:rgba(0,0,0,0.18);
      border:1px solid rgba(255,255,255,0.04);
      color:var(--text-color);
      font-family:inherit;
      font-size:14px;
    }
    .suggestion-form .row{ display:flex; gap:8px; margin-top:10px; }
    .suggestion-form .row input[type="text"]{
      flex:1;
      padding:8px 10px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.04);
      background:rgba(0,0,0,0.12);
      color:var(--text-color);
    }
    .suggestion-form button[type="submit"]{
      padding:8px 12px;
      border-radius:8px;
      background:var(--btn-bg);
      color:var(--btn-color);
      border:none;
      cursor:pointer;
      font-weight:700;
    }

    .suggestions-list{
      margin-top:12px;
      max-height:240px;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .suggestion-item{
      padding:8px;
      background:rgba(0,0,0,0.22);
      border-radius:8px;
      font-size:14px;
      color:var(--text-color);
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
    .suggestion-item .meta{
      font-size:12px;
      color:rgba(255,255,255,0.6);
      margin-bottom:6px;
    }
    .suggestion-item button { background:transparent;border:none;color:var(--nav-link-hover);cursor:pointer;font-weight:600 }

    @media (max-width:720px){
      :root{ --header-height:72px; --container-width:95vw }
      .center-wrap{ gap:4px }
      .top-row{ gap:10px }
      section{ padding:28px }
      #main-scene h2{ font-size:20px }
      nav a{ font-size:13px; padding:6px 6px }
      .header-right{ gap:6px }

      /* stack info + suggestions on mobile */
      #info .info-grid{ grid-template-columns: 1fr; }
      #info .info-left{ text-align:center }
      #info .info-right{ margin-top:8px }
    }
  </style>
</head>
<body>

  <!-- Canvas для частиц -->
  <canvas id="particles-canvas" aria-hidden="true" style="position:fixed;inset:0;z-index:0;pointer-events:none"></canvas>

  <!-- Header: center-block in middle column -->
  <header>
    <div></div> <!-- empty left column for symmetry -->

    <div class="center-wrap" role="banner" aria-label="Главная шапка">
      <div class="top-row">
        <h1 id="logo">sheyd</h1>

        <nav aria-label="Главная навигация">
          <a href="#main-scene" class="active">Главная</a>
          <a href="#status">Статус</a>
          <a href="#info">Информация</a>
        </nav>
      </div>

      <div style="display:flex;gap:8px;align-items:center;">
        <!-- visual balance -->
      </div>
    </div>

    <div class="header-right" aria-hidden="false">
      <button id="theme-toggle" class="chip" aria-label="Переключить тему">Светлая тема</button>
      <button id="ach-open" class="chip" title="Достижения" aria-label="Достижения">🏆</button>
      <button id="reset-storage" class="chip" title="Сбросить прогресс">Сброс</button>
    </div>
  </header>

  <main>
    <div class="container">
      <section id="main-scene" tabindex="-1" aria-label="Главная сцена">
        <h2>Sheyd</h2>
        <p>Проект, созданный с любовью и вниманием к деталям. Здесь вы найдете всё, что нужно для комфортного взаимодействия.</p>
        <a href="https://discord.gg/4muNVxCegd" target="_blank" rel="noopener noreferrer" class="btn" aria-label="Перейти на Discord сервер">ПЕРЕЙТИ</a>
      </section>

      <section id="status" tabindex="-1" aria-label="Статус сервера" style="display:none;">
        <h2>С конца сезона прошло</h2>
        <div id="time-since-season" style="font-weight:700;color:var(--header-text);margin-top:6px"></div>
        <div id="countdown" aria-live="polite" aria-atomic="true" style="font-weight:800;font-size:24px;margin-top:8px;color:var(--header-text)"></div>
      </section>

      <!-- Info section now contains two columns: left = info, right = suggestions -->
      <section id="info" tabindex="-1" aria-label="Информация" style="display:none;">
        <div class="info-grid">
          <div class="info-left">
            <h2>Информация</h2>
            <h3>О проекте</h3>
            <p>Sheyd - модовый приватный сервер. Здесь собираются обновления, новости и идеи от сообщества.</p>

            <div style="margin-top:14px">
              <p id="typing-text" aria-live="polite" aria-atomic="true" style="margin-top:8px"></p>
            </div>

            <div style="margin-top:16px; display:flex; gap:10px; flex-wrap:wrap;">
              <a class="btn" href="https://discord.gg/4muNVxCegd" target="_blank" rel="noopener noreferrer">Discord</a>
              <a class="btn" href="https://www.youtube.com/@Sheyd_s" target="_blank" rel="noopener noreferrer">YouTube</a>
              <a class="btn" href="https://t.me/sheyd_update" target="_blank" rel="noopener noreferrer">Telegram</a>
            </div>
          </div>

          <aside class="info-right" aria-label="Предложения пользователей">
            <h3 style="margin-top:0">Предложения</h3>
            <p style="font-size:13px;color:rgba(255,255,255,0.7);margin-bottom:8px">
              Напишите, что вы хотели бы видеть на сайте. В данный момент работает некорректно
            </p>

            <form id="suggestionForm" class="suggestion-form" aria-label="Форма предложений">
              <textarea id="suggestionInput" placeholder="Опишите идею или пожелание..." maxlength="1000" required></textarea>

              <div class="row" style="margin-top:8px">
                <input id="suggestionName" type="text" placeholder="Имя (необязательно)" maxlength="60" />
                <button type="submit" aria-label="Отправить предложение">Отправить</button>
              </div>
            </form>

            <div style="margin-top:12px; font-size:13px; color:rgba(255,255,255,0.7)">Последние предложения</div>
            <div id="suggestionsList" class="suggestions-list" aria-live="polite" aria-atomic="true"></div>

            <div style="margin-top:10px; display:flex; gap:8px;">
              <button id="clearSuggestions" class="chip" style="padding:6px 10px;font-size:13px">Очистить</button>
              <div id="suggestionsCount" style="margin-left:auto;font-size:13px;color:rgba(255,255,255,0.7)">0</div>
            </div>
          </aside>
        </div>
      </section>

      <section id="secret-section" tabindex="-1" aria-label="Секретная секция" style="display:none;">
        <h2>🎉 Секретная секция</h2>
        <p>Вы ввели секретную комбинацию клавиш — поздравляю!
        <p>Возвращайся позже, и здесь точно что-то будет.</p>
        </p>
        <div style="margin-top:12px"><button id="secret-back" class="btn">Вернуться</button></div>
      </section>

      <section id="sheyd-section" tabindex="-1" aria-label="SHEYD секция" style="display:none;">
        <h2>🔐 SHEYD</h2>
        <p>Вы ввели комбинацию <strong>S H E Y D</strong> — специальная секция открыта!</p>
        <p>Возвращайся позже, и здесь точно что-то будет.</p>
        <div style="margin-top:12px"><button id="sheyd-back" class="btn">Вернуться</button></div>
      </section>

      <section id="achievements" tabindex="-1" aria-label="Достижения" style="display:none;">
        <h2>🏆 Достижения</h2>
        <div id="ach-list" class="ach-list" aria-live="polite" style="margin-top:12px"></div>
        <div style="margin-top:12px"><button id="ach-back" class="btn">Вернуться</button></div>
      </section>

      <section id="bonus-section" tabindex="-1" aria-label="Бонусная секция" style="display:none;">
        <h2>🔒 Бонусная секция</h2>
        <p>Открывается отдельной секретной комбинацией (PAGE).</p>
        <p>Возвращайся позже, и здесь точно что-то будет.</p>
        <div style="margin-top:12px"><button id="bonus-back" class="btn">Вернуться</button></div>
      </section>
    </div>
  </main>

  <footer id="page-footer">
    <p>© 2025 Sheyd - Сделано с ❤️</p>
    <p>unknown stuff</p>
  </footer>

  <!-- modal & toast -->
  <div id="secret-modal" class="secret-modal" role="dialog" aria-modal="true" aria-hidden="true">
    <h3>🎉 Секрет открыт!</h3>
    <p>Ты нажал на логотип 10 раз — поздравляю! Вот твой секрет: <strong>✨ Удачи и хорошего дня!</strong></p>
    <p>Возвращайся позже, и здесь точно что-то будет.</p>
    <div style="margin-top:12px"><button id="close-secret" class="btn">Закрыть</button></div>
  </div>

  <div id="toast" role="status" aria-live="polite"></div>

  <script>
    // ----------------- Утилиты -----------------
    function showToast(text, timeout = 3000) {
      const t = document.getElementById('toast');
      if (!t) return;
      t.textContent = text;
      t.classList.add('show');
      clearTimeout(t._to);
      t._to = setTimeout(() => t.classList.remove('show'), timeout);
    }

    function safeGet(key, def) {
      try {
        const raw = localStorage.getItem(key);
        if (raw === null) return def;
        try { return JSON.parse(raw); } catch (e) {
          if (typeof def === 'string' || typeof def === 'number') return raw;
          localStorage.removeItem(key);
          return def;
        }
      } catch (e) {
        return def;
      }
    }
    function safeSet(key, val) {
      try {
        localStorage.setItem(key, JSON.stringify(val));
      } catch (e) {
        console.warn('safeSet failed for', key, e);
      }
    }

    // ----------------- Theme -----------------
    const themeToggleBtn = document.getElementById('theme-toggle');
    function setTheme(theme) {
      if (!themeToggleBtn) return;
      if (theme === 'light') {
        document.body.classList.add('light');
        themeToggleBtn.textContent = 'Тёмная тема';
      } else {
        document.body.classList.remove('light');
        themeToggleBtn.textContent = 'Светлая тема';
      }
      try { localStorage.setItem('theme', theme); } catch(e){}
    }
    if (themeToggleBtn) {
      themeToggleBtn.addEventListener('click', () => {
        const currentTheme = document.body.classList.contains('light') ? 'light' : 'dark';
        setTheme(currentTheme === 'light' ? 'dark' : 'light');
      });
    }
    const savedTheme = (function(){ try{return localStorage.getItem('theme')}catch(e){return null}})();
    if (savedTheme) setTheme(savedTheme);
    else setTheme('dark');

    // ----------------- Navigation -----------------
    const navLinks = document.querySelectorAll('nav a');
    const sections = document.querySelectorAll('main section');

    function renderSuggestions() {
      // Render local immediately as placeholder; firebase listener (if available) will replace it when ready
      renderLocalSuggestions();
    }

    function showSectionById(id) {
      sections.forEach(sec => {
        if (sec.id === id) sec.style.display = 'flex';
        else sec.style.display = 'none';
      });
      navLinks.forEach(a => a.classList.remove('active'));
      const link = Array.from(navLinks).find(a => a.getAttribute('href').substring(1) === id);
      if (link) link.classList.add('active');

      // When info opened: start typing and render suggestions
      if (id === 'info') {
        startTypingAnimation();
        if (typeof renderSuggestions === 'function') renderSuggestions();
      }
    }

    navLinks.forEach(link => link.addEventListener('click', (e) => {
      e.preventDefault();
      const targetId = link.getAttribute('href').substring(1);
      showSectionById(targetId);
    }));

    // ----------------- Suggestions: Firebase-backed with local-first fallback -----------------
    const firebaseConfig = {
      apiKey: "AIzaSyAumrOiYVSFcqzWV9uM5-E_lZA80XpfDZg",
      authDomain: "sheyd-f7e36.firebaseapp.com",
      databaseURL: "https://sheyd-f7e36-default-rtdb.firebaseio.com",
      projectId: "sheyd-f7e36",
      storageBucket: "sheyd-f7e36.firebasestorage.app",
      messagingSenderId: "534336964574",
      appId: "1:534336964574:web:fdc015c5726dface1aff4f",
      measurementId: "G-SW46F9KY83"
    };
    const useFirebase = !!(firebaseConfig && firebaseConfig.apiKey && firebaseConfig.databaseURL);

    // local storage key
    const SUG_KEY = 'siteSuggestions';

    // queue to hold entries that should be sent to firebase when it becomes available
    const suggestionsQueue = [];

    // add single suggestion item to UI (used by both renderers)
    function addSuggestionToUI(s, container) {
      const listEl = container || document.getElementById('suggestionsList');
      if (!listEl) return;
      const item = document.createElement('div');
      item.className = 'suggestion-item';
      const left = document.createElement('div');
      left.style.flex = '1';
      const meta = document.createElement('div');
      meta.className = 'meta';
      const name = s.name ? s.name : 'Аноним';
      meta.textContent = `${name} • ${s.ts ? new Date(s.ts).toLocaleString() : ''}`;
      const txt = document.createElement('div');
      txt.textContent = s.text;
      left.appendChild(meta);
      left.appendChild(txt);

      const right = document.createElement('div');
      right.style.display = 'flex';
      right.style.flexDirection = 'column';
      right.style.alignItems = 'flex-end';
      right.style.gap = '6px';

      const del = document.createElement('button');
      del.type = 'button';
      del.title = 'Удалить предложение';
      del.textContent = 'Удалить';
      del.addEventListener('click', () => {
        if (useFirebase && s._key) {
          if (confirm('Удалить это предложение с сервера?')) {
            import('https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js').then(dbMod => {
              const { getDatabase, ref, remove } = dbMod;
              const db = getDatabase(window.__firebaseApp);
              remove(ref(db, 'suggestions/' + s._key)).then(() => {
                showToast('Запись удалена (сервер).', 1600);
              }).catch(err => {
                console.error(err);
                showToast('Не удалось удалить (проверьте правила базы).', 2000);
              });
            });
          }
        } else {
          const arr = safeGet(SUG_KEY, []);
          const newArr = arr.filter(it => it.ts !== s.ts || (it.text !== s.text));
          safeSet(SUG_KEY, newArr);
          renderLocalSuggestions();
          showToast('Предложение удалено (локально)', 1400);
        }
      });

      right.appendChild(del);
      item.appendChild(left);
      item.appendChild(right);
      listEl.appendChild(item);
    }

    // ---------- LocalStorage renderer (fallback) ----------
    function loadLocalSuggestions() {
      const arr = safeGet(SUG_KEY, []);
      if (!Array.isArray(arr)) return [];
      return arr;
    }
    function saveLocalSuggestions(arr) { safeSet(SUG_KEY, arr); }
    function renderLocalSuggestions() {
      const listEl = document.getElementById('suggestionsList');
      const countEl = document.getElementById('suggestionsCount');
      if (!listEl || !countEl) return;
      const arr = loadLocalSuggestions();
      listEl.innerHTML = '';
      if (arr.length === 0) {
        listEl.innerHTML = '<div style="color:rgba(255,255,255,0.6);font-size:13px">Ещё нет предложений — будьте первым!</div>';
      } else {
        arr.slice().reverse().forEach(s => addSuggestionToUI(s));
      }
      countEl.textContent = arr.length;
    }

    // ---------- Provide a submitSuggestionRemote immediately (local-first) ----------
    // This function always returns a Promise, so the form handler can chain .then(...)
    window.submitSuggestionRemote = function(text, name) {
      const entry = { text, name: name||null, ts: Date.now() };
      // save locally first
      const arr = loadLocalSuggestions();
      arr.push(entry);
      saveLocalSuggestions(arr);
      renderLocalSuggestions();
      // queue for remote push (if/when firebase becomes available)
      suggestionsQueue.push(entry);
      showToast('Спасибо! Предложение сохранено локально и будет синхронизировано.', 1800);
      return Promise.resolve();
    };

    // ---------- Firebase integration ----------
    if (useFirebase) {
      (async () => {
        try {
          const appMod = await import('https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js');
          const dbMod = await import('https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js');
          const { initializeApp } = appMod;
          const { getDatabase, ref, onValue, push, remove } = dbMod;
          const firebaseApp = initializeApp(firebaseConfig);
          window.__firebaseApp = firebaseApp;
          const db = getDatabase(firebaseApp);
          const suggestionsRef = ref(db, 'suggestions');

          // Listener: при изменениях рендерим список заново (серверные данные имеют приоритет)
          onValue(suggestionsRef, snapshot => {
            const listEl = document.getElementById('suggestionsList');
            const countEl = document.getElementById('suggestionsCount');
            if (!listEl || !countEl) return;
            listEl.innerHTML = '';
            const val = snapshot.val() || {};
            const items = Object.keys(val).map(k => Object.assign({}, val[k], { _key: k }));
            // сортировка по времени (новые сверху)
            items.sort((a,b) => (b.ts || 0) - (a.ts || 0));
            if (items.length === 0) {
              listEl.innerHTML = '<div style="color:rgba(255,255,255,0.6);font-size:13px">Ещё нет предложений — будьте первым!</div>';
            } else {
              items.forEach(it => addSuggestionToUI(it));
            }
            countEl.textContent = items.length;
          });

          // Replace submit function with real remote push, but keep local-first semantics
          window.submitSuggestionRemote = async function(text, name) {
            const entry = { text, name: name||null, ts: Date.now() };
            // already saved locally by earlier default; ensure local storage contains it
            const arr = loadLocalSuggestions();
            if (!arr.some(e => e.ts === entry.ts && e.text === entry.text)) {
              arr.push(entry);
              saveLocalSuggestions(arr);
              renderLocalSuggestions();
            }
            // push to remote
            try {
              await push(ref(db, 'suggestions'), entry);
              showToast('Спасибо! Предложение отправлено.', 1600);
              return Promise.resolve();
            } catch (err) {
              console.error('push error', err);
              // queue for later
              suggestionsQueue.push(entry);
              showToast('Ошибка отправки в Firebase — запись сохранена локально и будет повторена.', 2000);
              return Promise.reject(err);
            }
          };

          // function to flush queued entries
          async function flushQueue() {
            while (suggestionsQueue.length > 0) {
              const e = suggestionsQueue.shift();
              try {
                await push(ref(db, 'suggestions'), e);
                // ok
              } catch (err) {
                console.error('flush error', err);
                // push back and stop trying now
                suggestionsQueue.unshift(e);
                break;
              }
            }
          }

          // try to flush queued entries once firebase is ready
          flushQueue().catch(err => { console.warn('Could not flush suggestions queue now', err); });

          // expose clear remote
          window.clearAllRemoteSuggestions = async function() {
            try {
              await remove(ref(db, 'suggestions'));
              showToast('Все предложения удалены на сервере (если это разрешено).', 1800);
            } catch (err) {
              console.error(err);
              showToast('Не удалось очистить сервер (проверьте правила).', 2000);
            }
          };

        } catch (err) {
          console.error('Firebase init failed', err);
          showToast('Не удалось подключиться к Firebase — используется локальное хранилище.', 2500);
          // if firebase fails, we already have a local submitSuggestionRemote defined above
          renderLocalSuggestions();
        }
      })();
    } else {
      // no firebase config — local fallback already provided; render now
      renderLocalSuggestions();
    }

    // --------------- Form handling ----------------
    const suggestionForm = document.getElementById('suggestionForm');
    const suggestionInput = document.getElementById('suggestionInput');
    const suggestionName = document.getElementById('suggestionName');
    const clearBtn = document.getElementById('clearSuggestions');

    if (suggestionForm) {
      suggestionForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const text = (suggestionInput.value || '').trim();
        const name = (suggestionName.value || '').trim();
        if (!text) {
          showToast('Пожалуйста, введите текст предложения', 1600);
          return;
        }
        if (text.length > 1000) {
          showToast('Слишком длинное предложение (макс 1000 символов)', 1800);
          return;
        }
        // submitSuggestionRemote always exists and returns a Promise
        try {
          window.submitSuggestionRemote(text, name)
            .then(() => {
              suggestionInput.value = '';
              suggestionName.value = '';
            })
            .catch(() => {
              suggestionInput.value = '';
              suggestionName.value = '';
            });
        } catch (err) {
          // fallback: save locally
          const entry = { text, name: name||null, ts: Date.now() };
          const arr = loadLocalSuggestions();
          arr.push(entry);
          saveLocalSuggestions(arr);
          renderLocalSuggestions();
          suggestionInput.value = '';
          suggestionName.value = '';
          showToast('Спасибо! Предложение сохранено локально', 1800);
        }
      });
    }

    if (clearBtn) {
      clearBtn.addEventListener('click', () => {
        if (!confirm('Очистить все предложения? Это удалит локальные записи.')) return;
        if (useFirebase && typeof window.clearAllRemoteSuggestions === 'function') {
          window.clearAllRemoteSuggestions();
        }
        saveLocalSuggestions([]);
        renderLocalSuggestions();
        showToast('Локальные предложения очищены', 1600);
      });
    }

    // ----------------- Controls & other behaviors (kept) -----------------
    document.getElementById('ach-open')?.addEventListener('click', () => { showSectionById('achievements'); populateAchievements(); });
    document.getElementById('ach-back')?.addEventListener('click', () => showSectionById('main-scene'));
    document.getElementById('secret-back')?.addEventListener('click', () => showSectionById('main-scene'));
    document.getElementById('sheyd-back')?.addEventListener('click', () => showSectionById('main-scene'));
    document.getElementById('bonus-back')?.addEventListener('click', () => showSectionById('main-scene'));

    // Visits & achievements (kept)
    (function initVisits() {
      let visitsRaw = null;
      try { visitsRaw = localStorage.getItem('visits'); } catch(e) { visitsRaw = null; }
      let visitsNum = 0;
      if (visitsRaw === null) visitsNum = 0;
      else {
        const parsed = parseInt(visitsRaw, 10);
        visitsNum = Number.isNaN(parsed) ? 0 : parsed;
      }
      visitsNum++;
      try { localStorage.setItem('visits', String(visitsNum)); } catch(e){}
      window.__visits = visitsNum;
    })();
    let visits = window.__visits || 0;

    const ACH_KEYS = { visited100: 'visited100', found3eggs: 'found3eggs' };
    let achievementsState = safeGet('achievementsState', { visited100:false, found3eggs:false, eggs: [], dates: {} });
    if (!achievementsState[ACH_KEYS.visited100] && visits >= 100) {
      achievementsState[ACH_KEYS.visited100] = true;
      achievementsState.dates = achievementsState.dates || {};
      achievementsState.dates[ACH_KEYS.visited100] = new Date().toLocaleString();
      safeSet('achievementsState', achievementsState);
      showToast('🏆 Достижение разблокировано: посетил сайт 100 раз');
    } else { safeSet('achievementsState', achievementsState); }

    function markEgg(id, title) {
      const state = safeGet('achievementsState', { visited100:false, found3eggs:false, eggs: [], dates: {} });
      state.eggs = state.eggs || [];
      if (!state.eggs.includes(id)) {
        state.eggs.push(id);
        if (id === 'footer') startFooterScramble();
        if (!state.found3eggs && state.eggs.length >= 3) {
          state.found3eggs = true;
          state.dates = state.dates || {};
          state.dates.found3eggs = new Date().toLocaleString();
          showToast('🏆 Достижение разблокировано: нашёл 3 пасхалки', 3000);
        }
        safeSet('achievementsState', state);
        showToast('✨ Пасхалка найдена: ' + title, 2200);
        populateAchievements();
      }
    }

    // Footer scramble
    const footerEl = document.getElementById('page-footer');
    let footerScrambleInterval = null;
    let footerOriginalParagraphs = [];
    let footerScrambleActive = false;
    function randomSymbolString(len) {
      const chars = '╳✶★✦✺✻✼•◦¤♦♢♧☰☯✪✷✹✸✺✻✽✾@$%&*?=+~<>/\\|[]{}0123456789';
      let out = '';
      for (let i = 0; i < len; i++) out += chars.charAt(Math.floor(Math.random() * chars.length));
      return out;
    }
    function startFooterScramble(duration = 8000, speed = 160) {
      if (!footerEl || footerScrambleActive) return;
      footerScrambleActive = true;
      const ps = footerEl.querySelectorAll('p');
      footerOriginalParagraphs = Array.from(ps).map(p => p.textContent);
      footerScrambleInterval = setInterval(() => {
        const ps2 = footerEl.querySelectorAll('p');
        ps2.forEach((p, idx) => {
          const len = Math.max(6, Math.min(22, footerOriginalParagraphs[idx] ? footerOriginalParagraphs[idx].length : 10));
          p.textContent = randomSymbolString(Math.floor(Math.random() * (len - 3)) + 3);
        });
        footerEl.style.transform = `translateY(${(Math.random()-0.5)*2}px) rotate(${(Math.random()-0.5)*0.5}deg)`;
      }, speed);
      setTimeout(() => {
        clearInterval(footerScrambleInterval);
        const ps3 = footerEl.querySelectorAll('p');
        ps3.forEach((p, idx) => p.textContent = footerOriginalParagraphs[idx] || p.textContent);
        footerEl.style.transform = '';
        footerScrambleActive = false;
      }, duration);
    }

    // Footer dblclick egg
    footerEl?.addEventListener('dblclick', () => { markEgg('footer','Футер (двойной клик)'); showToast('✨ Пасхалка найдена: двойной клик по футеру',2000); });

    // Logo easter (10 clicks)
    const logo = document.getElementById('logo');
    const secretModal = document.getElementById('secret-modal');
    const closeSecretBtn = document.getElementById('close-secret');
    let logoClickCount = 0, secretShown = false;
    if (logo) {
      logo.addEventListener('click', () => {
        logoClickCount++;
        if (logoClickCount === 10 && !secretShown) {
          secretModal.classList.add('show');
          secretModal.setAttribute('aria-hidden', 'false');
          secretShown = true;
          markEgg('logo', 'Логотип (10 кликов)');
        }
      });
    }
    closeSecretBtn?.addEventListener('click', ()=>{ secretModal.classList.remove('show'); secretModal.setAttribute('aria-hidden','true') });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { secretModal.classList.remove('show'); secretModal.setAttribute('aria-hidden','true') } });

    // Reset logo counter after inactivity
    (function(){
      if(!logo) return;
      let last=0;
      logo.addEventListener('click', ()=>{ const now=Date.now(); if(last && (now-last)>30000) logoClickCount=1; last=now });
    })();

    // Secret combos (Konami, ACH, PAGE, SHEYD)
    const konamiSequence = ['arrowup','arrowup','arrowdown','arrowdown','arrowleft','arrowright','arrowleft','arrowright'];
    let konamiIndex = 0;
    const comboACH = ['a','c','h']; let achIndex = 0;
    const comboPAGE = ['p','a','g','e']; let pageIndex = 0;
    const comboSHEY = ['s','h','e','y','d']; let sheyIndex = 0;

    document.addEventListener('keydown', (e) => {
      const target = e.target;
      if (target && (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.isContentEditable)) return;
      const key = (e.key || '').toLowerCase();

      // KONAMI
      if (key === konamiSequence[konamiIndex]) {
        konamiIndex++;
        if (konamiIndex === konamiSequence.length) {
          konamiIndex = 0;
          showSectionById('secret-section');
          markEgg('konami', 'Konami Code (↑↑↓↓←→←→)');
          showToast('Секретная секция открыта!');
        }
      } else { konamiIndex = (key === konamiSequence[0]) ? 1 : 0; }

      // ACH
      if (key === comboACH[achIndex]) {
        achIndex++;
        if (achIndex === comboACH.length) { achIndex=0; showSectionById('achievements'); populateAchievements(); showToast('Открыты Достижения (секрет: A C H)'); }
      } else { achIndex = (key === comboACH[0]) ? 1 : 0; }

      // PAGE
      if (key === comboPAGE[pageIndex]) {
        pageIndex++;
        if (pageIndex === comboPAGE.length) { pageIndex=0; showSectionById('bonus-section'); showToast('Открыта бонусная секция (секрет: PAGE)'); }
      } else { pageIndex = (key === comboPAGE[0]) ? 1 : 0; }

      // SHEYD
      if (key === comboSHEY[sheyIndex]) {
        sheyIndex++;
        if (sheyIndex === comboSHEY.length) { sheyIndex=0; showSectionById('sheyd-section'); markEgg('sheyd','Комбинация SHEYD'); showToast('Открыта секция SHEYD (секрет: S H E Y D)'); }
      } else { sheyIndex = (key === comboSHEY[0]) ? 1 : 0; }
    });

    // Achievements UI
    const ACHS = [
      { id: 'found3eggs', title: 'Нашёл 3 пасхалки', desc: 'Найди 3 скрытые пасхалки на сайте' },
      { id: 'visited100', title: 'Посетил сайт 100 раз', desc: 'Открой сайт 100 раз' }
    ];
    function populateAchievements() {
      const list = document.getElementById('ach-list');
      if (!list) return;
      list.innerHTML = '';
      const state = safeGet('achievementsState', { visited100:false, found3eggs:false, eggs:[], dates:{} });
      ACHS.forEach(a => {
        const unlocked = !!state[a.id];
        const item = document.createElement('div');
        item.style.display='flex'; item.style.justifyContent='space-between'; item.style.alignItems='center';
        item.style.padding='12px'; item.style.borderBottom='1px dashed rgba(255,255,255,0.03)';
        item.innerHTML = `
          <div style="text-align:left">
            <div style="font-weight:700">${a.title}</div>
            <div style="font-size:13px;color:rgba(255,255,255,0.8)">${a.desc}</div>
          </div>
          <div style="text-align:right">
            <div style="padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.04);font-weight:600">${unlocked ? 'Unlocked' : 'Locked'}</div>
            ${unlocked ? '<div style="font-size:12px;margin-top:6px;color:rgba(255,255,255,0.6)">' + (state.dates && (state.dates[a.id] || state.dates[a.id + '_date']) ? (state.dates[a.id] || state.dates[a.id + '_date']) : '') + '</div>' : ''}
          </div>
        `;
        list.appendChild(item);
      });

      const eggsCount = (state.eggs || []).length;
      const eggsElem = document.createElement('div');
      eggsElem.style.marginTop = '12px';
      eggsElem.style.fontWeight = '600';
      eggsElem.textContent = `Пасхалки: ${eggsCount} / 3`;
      list.appendChild(eggsElem);

      const visitsElem = document.createElement('div');
      visitsElem.style.marginTop = '10px';
      visitsElem.style.fontWeight = '600';
      visitsElem.textContent = `Посещения: ${visits}`;
      list.appendChild(visitsElem);
    }

    (function ensureDatesSaved() {
      const state = safeGet('achievementsState', { visited100:false, found3eggs:false, eggs:[], dates:{} });
      state.dates = state.dates || {};
      if (state.visited100 && !state.dates.visited100) state.dates.visited100 = new Date().toLocaleString();
      if (state.found3eggs && !state.dates.found3eggs) state.dates.found3eggs = new Date().toLocaleString();
      safeSet('achievementsState', state);
    })();

    // init
    showSectionById('main-scene');
    populateAchievements();
    (function notifyExisting() {
      const s = safeGet('achievementsState', { visited100:false, found3eggs:false, eggs:[], dates:{} });
      if (s.visited100) showToast('✔ У вас есть: посетил сайт 100 раз', 2000);
      if (s.found3eggs) showToast('✔ У вас есть: нашёл 3 пасхалки', 2000);
    })();

    (function watchStateChanges() {
      setInterval(() => {
        const s = safeGet('achievementsState', { visited100:false, found3eggs:false, eggs:[], dates:{} });
        if (!s.dates) s.dates = {};
        if (s.visited100 && !s.dates.visited100) { s.dates.visited100 = new Date().toLocaleString(); safeSet('achievementsState', s); }
        if (s.found3eggs && !s.dates.found3eggs) { s.dates.found3eggs = new Date().toLocaleString(); safeSet('achievementsState', s); }
      }, 2000);
    })();

    // Reset storage
    document.getElementById('reset-storage')?.addEventListener('click', () => {
      if (!confirm('Сбросить локальные данные (посещения и достижения)?')) return;
      try { localStorage.removeItem('visits'); localStorage.removeItem('achievementsState'); } catch(e){}
      showToast('Локальные данные удалены. Пожалуйста, перезагрузите страницу.', 3000);
    });

    // ensure suggestions render when page loaded (but keep info hidden until user opens it)
    document.addEventListener('DOMContentLoaded', () => {
      // Pre-render suggestions count for local (if any)
      const countEl = document.getElementById('suggestionsCount');
      if (countEl) countEl.textContent = safeGet(SUG_KEY, []).length;
      // render suggestions only when info opened to avoid visual rerender costs; renderLocalSuggestions called by renderSuggestions()
    });

    // ----------------- Typing animation & Particles (kept) -----------------
    // Countdown
    const countdownEl = document.getElementById('countdown');
    const timeSinceEl = document.getElementById('time-since-season');
    const seasonEnd = new Date('2024-12-11T00:00:00Z');
    function updateCountdown() {
      const now = new Date();
      let diff = now - seasonEnd;
      if (diff < 0) diff = 0;
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
      const minutes = Math.floor((diff / (1000 * 60)) % 60);
      const seconds = Math.floor((diff / 1000) % 60);
      if (timeSinceEl) timeSinceEl.textContent = `${days} дн. ${hours} ч. ${minutes} мин.`;
      if (countdownEl) countdownEl.textContent = `${days} : ${hours.toString().padStart(2,'0')} : ${minutes.toString().padStart(2,'0')} : ${seconds.toString().padStart(2,'0')}`;
    }
    setInterval(updateCountdown, 1000);
    updateCountdown();

    // Typing animation
    const typingTextEl = document.getElementById('typing-text');
    const infoMessages = [
      "Добро пожаловать на сайт Sheyd — ваш надежный источник информации.",
      "Следите за обновлениями и не пропустите важное!",
      "Подключайтесь к нашим сообществам в Discord, YouTube и Telegram.",
    ];
    let typingIndex = 0, charIndex = 0, isTyping = false;
    function startTypingAnimation() {
      if (isTyping || !typingTextEl) return;
      isTyping = true;
      function type() {
        if (charIndex < infoMessages[typingIndex].length) {
          typingTextEl.textContent += infoMessages[typingIndex].charAt(charIndex++);
          setTimeout(type, 50);
        } else {
          setTimeout(erase, 1800);
        }
      }
      function erase() {
        if (charIndex > 0) {
          typingTextEl.textContent = infoMessages[typingIndex].substring(0, --charIndex);
          setTimeout(erase, 30);
        } else {
          typingIndex = (typingIndex + 1) % infoMessages.length;
          setTimeout(type, 300);
        }
      }
      typingTextEl.textContent = '';
      charIndex = 0;
      type();
    }

    // Particles (light)
    const particlesCanvas = document.getElementById('particles-canvas');
    const particlesCtx = particlesCanvas && particlesCanvas.getContext ? particlesCanvas.getContext('2d') : null;
    let particleArray = [];
    function resizeParticlesCanvas() {
      if (!particlesCanvas) return;
      particlesCanvas.width = window.innerWidth;
      particlesCanvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeParticlesCanvas);
    resizeParticlesCanvas();
    class Particle {
      constructor(){ this.reset() }
      reset(){ this.x=Math.random()*particlesCanvas.width; this.y=Math.random()*-particlesCanvas.height; this.size=Math.random()*3+0.6; this.speedY=Math.random()*1.6+0.4; this.speedX=(Math.random()-0.5)*0.4 }
      update(){ this.y+=this.speedY; this.x+=this.speedX; if(this.y>particlesCanvas.height) this.reset() }
      draw(){ if(!particlesCtx) return; particlesCtx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--particle-color'); particlesCtx.beginPath(); particlesCtx.arc(this.x,this.y,this.size,0,Math.PI*2); particlesCtx.fill() }
    }
    function initParticles(){ if(!particlesCanvas) return; particleArray=[]; for(let i=0;i<80;i++) particleArray.push(new Particle()) }
    function animateParticles(){ if(!particlesCtx||!particlesCanvas) return; particlesCtx.clearRect(0,0,particlesCanvas.width,particlesCanvas.height); particleArray.forEach(p=>{ p.update(); p.draw(); }); requestAnimationFrame(animateParticles) }
    initParticles(); animateParticles();

  </script>
</body>
</html>
